<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>wjsun&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="build recently">
<meta property="og:type" content="website">
<meta property="og:title" content="wjsun&#39;s Blog">
<meta property="og:url" content="https://sabyic.github.io/index.html">
<meta property="og:site_name" content="wjsun&#39;s Blog">
<meta property="og:description" content="build recently">
<meta property="og:locale">
<meta property="article:author" content="wjsun">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="wjsun's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">wjsun&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">mainly about llvm</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Suche"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://SabYic.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-2020.5.21" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/21/2020.5.21/" class="article-date">
  <time class="dt-published" datetime="2025-05-21T07:00:44.710Z" itemprop="datePublished">2025-05-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/05/21/2020.5.21/">2025-5-21-为什么官方LLVM会报错的思考</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>目前在试图看出来为什么新官方llvm编译half.ll会报错，目前认为不是指令的问题，应该是ll文件的问题。这是2025年LLVM中关于fnmadd的相关ll，它专门建立了一个文件叫做fnmadd.ll</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py</span><br><span class="line">; RUN: sed &#x27;s/iXLen/i32/g&#x27; %s | llc -mtriple=riscv32 -mattr=+v,+zvfh \</span><br><span class="line">; RUN:   -verify-machineinstrs -target-abi=ilp32d | FileCheck %s</span><br><span class="line">; RUN: sed &#x27;s/iXLen/i64/g&#x27; %s | llc -mtriple=riscv64 -mattr=+v,+zvfh \</span><br><span class="line">; RUN:   -verify-machineinstrs -target-abi=lp64d | FileCheck %s</span><br><span class="line"></span><br><span class="line">declare &lt;vscale x 1 x half&gt; @llvm.riscv.vfnmadd.nxv1f16.nxv1f16(</span><br><span class="line">  &lt;vscale x 1 x half&gt;,</span><br><span class="line">  &lt;vscale x 1 x half&gt;,</span><br><span class="line">  &lt;vscale x 1 x half&gt;,</span><br><span class="line">  iXLen, iXLen, iXLen);</span><br><span class="line"></span><br><span class="line">define &lt;vscale x 1 x half&gt;  @intrinsic_vfnmadd_vv_nxv1f16_nxv1f16_nxv1f16(&lt;vscale x 1 x half&gt; %0, &lt;vscale x 1 x half&gt; %1, &lt;vscale x 1 x half&gt; %2, iXLen %3) nounwind &#123;</span><br><span class="line">; CHECK-LABEL: intrinsic_vfnmadd_vv_nxv1f16_nxv1f16_nxv1f16:</span><br><span class="line">; CHECK:       # %bb.0: # %entry</span><br><span class="line">; CHECK-NEXT:    fsrmi a1, 0</span><br><span class="line">; CHECK-NEXT:    vsetvli zero, a0, e16, mf4, tu, ma</span><br><span class="line">; CHECK-NEXT:    vfnmadd.vv v8, v9, v10</span><br><span class="line">; CHECK-NEXT:    fsrm a1</span><br><span class="line">; CHECK-NEXT:    ret</span><br><span class="line">entry:</span><br><span class="line">  %a = call &lt;vscale x 1 x half&gt; @llvm.riscv.vfnmadd.nxv1f16.nxv1f16(</span><br><span class="line">    &lt;vscale x 1 x half&gt; %0,</span><br><span class="line">    &lt;vscale x 1 x half&gt; %1,</span><br><span class="line">    &lt;vscale x 1 x half&gt; %2,</span><br><span class="line">    iXLen 0, iXLen %3, iXLen 0)</span><br><span class="line"></span><br><span class="line">  ret &lt;vscale x 1 x half&gt; %a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare &lt;vscale x 1 x half&gt; @llvm.riscv.vfnmadd.mask.nxv1f16.nxv1f16(</span><br><span class="line">  &lt;vscale x 1 x half&gt;,</span><br><span class="line">  &lt;vscale x 1 x half&gt;,</span><br><span class="line">  &lt;vscale x 1 x half&gt;,</span><br><span class="line">  &lt;vscale x 1 x i1&gt;,</span><br><span class="line">  iXLen, iXLen, iXLen);</span><br><span class="line"></span><br><span class="line">define &lt;vscale x 1 x half&gt;  @intrinsic_vfnmadd_mask_vv_nxv1f16_nxv1f16_nxv1f16(&lt;vscale x 1 x half&gt; %0, &lt;vscale x 1 x half&gt; %1, &lt;vscale x 1 x half&gt; %2, &lt;vscale x 1 x i1&gt; %3, iXLen %4) nounwind &#123;</span><br><span class="line">; CHECK-LABEL: intrinsic_vfnmadd_mask_vv_nxv1f16_nxv1f16_nxv1f16:</span><br><span class="line">; CHECK:       # %bb.0: # %entry</span><br><span class="line">; CHECK-NEXT:    fsrmi a1, 0</span><br><span class="line">; CHECK-NEXT:    vsetvli zero, a0, e16, mf4, tu, mu</span><br><span class="line">; CHECK-NEXT:    vfnmadd.vv v8, v9, v10, v0.t</span><br><span class="line">; CHECK-NEXT:    fsrm a1</span><br><span class="line">; CHECK-NEXT:    ret</span><br><span class="line">entry:</span><br><span class="line">  %a = call &lt;vscale x 1 x half&gt; @llvm.riscv.vfnmadd.mask.nxv1f16.nxv1f16(</span><br><span class="line">    &lt;vscale x 1 x half&gt; %0,</span><br><span class="line">    &lt;vscale x 1 x half&gt; %1,</span><br><span class="line">    &lt;vscale x 1 x half&gt; %2,</span><br><span class="line">    &lt;vscale x 1 x i1&gt; %3,</span><br><span class="line">    iXLen 0, iXLen %4, iXLen 0);</span><br><span class="line"></span><br><span class="line">  ret &lt;vscale x 1 x half&gt; %a</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是这是老版本的half.ll</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">; Function Attrs: mustprogress nofree norecurse nosync nounwind willreturn memory(none)</span><br><span class="line">define dso_local half @fnmadd_f(half noundef %a, half noundef %b, half noundef %c) local_unnamed_addr  &#123;</span><br><span class="line">; VENTUS-LABEL: fnmadd_f:</span><br><span class="line">; VENTUS:       # %bb.0: # %entry</span><br><span class="line">; VENTUS-NEXT:    lui t0, %hi(.LCPI26_0)</span><br><span class="line">; VENTUS-NEXT:    lw t0, %lo(.LCPI26_0)(t0)</span><br><span class="line">; VENTUS-NEXT:    vadd.vx v0, v1, zero</span><br><span class="line">; VENTUS-NEXT:    vmv.v.x v1, t0</span><br><span class="line">; VENTUS-NEXT:    vfmsub.vv v0, v1, v2</span><br><span class="line">; VENTUS-NEXT:    ret</span><br><span class="line">entry:</span><br><span class="line">  %fneg = fmul half %b, 0xBFF3333340000000</span><br><span class="line">  %sub = fsub half %fneg, %c</span><br><span class="line">  ret half %sub</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>导致出错的正好是0xBFF333334000000，相关数字在新LLVM中完全消失了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sabyic.github.io/2025/05/21/2020.5.21/" data-id="cmaxlgd6b0000kzq25la4h5yb" data-title="2025-5-21-为什么官方LLVM会报错的思考" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/21/hello-world/" class="article-date">
  <time class="dt-published" datetime="2025-05-21T07:00:44.710Z" itemprop="datePublished">2025-05-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/05/21/hello-world/">ventus LLVM 初步 调研</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Pretask-J142-PLCT-20250510"><a href="#Pretask-J142-PLCT-20250510" class="headerlink" title="Pretask-J142-PLCT-20250510"></a>Pretask-J142-PLCT-20250510</h1><h2 id="乘影-LLVM-与官方-LLVM-的-RISC-V-ZVFH-扩展支持对比及指令选择阶段分析"><a href="#乘影-LLVM-与官方-LLVM-的-RISC-V-ZVFH-扩展支持对比及指令选择阶段分析" class="headerlink" title="乘影 LLVM 与官方 LLVM 的 RISC-V ZVFH 扩展支持对比及指令选择阶段分析"></a>乘影 LLVM 与官方 LLVM 的 RISC-V ZVFH 扩展支持对比及指令选择阶段分析</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>主要对比乘影 LLVM（ventus-llvm）与官方 LLVM 在 ZVFH 扩展支持方面的实现差异，特别关注指令选择阶段。需要同时在 float 和 half 数据类型上做测试。</p>
<h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><p>学习前置知识了解了zvfh和zvfhmin是什么</p>
<h3 id="1-环境搭建与验证"><a href="#1-环境搭建与验证" class="headerlink" title="1. 环境搭建与验证"></a>1. 环境搭建与验证</h3><ul>
<li>克隆乘影编译器源码仓库 ventus-llvm（J142 岗位描述中提供），编译并成功构建 ventus-llvm。跑通 README 中给出的示例。<br>  成功编译产生llc，但是没有成功编译产生vecadd，原因出在gcc版本和clang的版本上。</li>
</ul>
<h3 id="2-乘影-LLVM-向量-float-测试"><a href="#2-乘影-LLVM-向量-float-测试" class="headerlink" title="2. 乘影 LLVM 向量 float 测试"></a>2. 乘影 LLVM 向量 float 测试</h3><p>这里需注意的，应该在build ventus-llvm的时候开启debug选项，不然编译出来release版本就没有办法看debug信息了！</p>
<h4 id="参考-Pretask-20250424-中“附录2：开发提示-标量-half-类型支持”的写法，使用乘影编译器的-llc-对-Pretask-20250424-的“调研提示”中提到的-float-ll-进行编译。"><a href="#参考-Pretask-20250424-中“附录2：开发提示-标量-half-类型支持”的写法，使用乘影编译器的-llc-对-Pretask-20250424-的“调研提示”中提到的-float-ll-进行编译。" class="headerlink" title="-参考 Pretask-20250424 中“附录2：开发提示 - 标量 half 类型支持”的写法，使用乘影编译器的 llc 对 Pretask-20250424 的“调研提示”中提到的 float.ll 进行编译。"></a>-参考 Pretask-20250424 中“附录2：开发提示 - 标量 half 类型支持”的写法，使用乘影编译器的 <code>llc</code> 对 Pretask-20250424 的“调研提示”中提到的 <code>float.ll</code> 进行编译。</h4><p>我使用命令<code>/home/sunwenjia/ventus/llvm-project/install/bin/llc --debug-only=isel float.ll &amp;&gt; ~/output2.log</code><br>观察产生MIR的代码，发现是x86MIR。</p>
<h4 id="添加编译选项-debug-only-isel，打印出指令选择阶段的-log-文件。"><a href="#添加编译选项-debug-only-isel，打印出指令选择阶段的-log-文件。" class="headerlink" title="添加编译选项 --debug-only=isel，打印出指令选择阶段的 log 文件。"></a>添加编译选项 <code>--debug-only=isel</code>，打印出指令选择阶段的 log 文件。</h4><p>生成log如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">=== fadd_v</span><br><span class="line">Initial selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg # D:1 t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg # D:1 t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd # D:1 t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg # D:1 t0, Register:f32 $v0, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_FLAG # D:1 t7, Register:f32 $v0, t7:1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Optimized lowered selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg # D:1 t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg # D:1 t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd # D:1 t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg # D:1 t0, Register:f32 $v0, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_FLAG # D:1 t7, Register:f32 $v0, t7:1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Type-legalized selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg # D:1 t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg # D:1 t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd # D:1 t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg # D:1 t0, Register:f32 $v0, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_FLAG # D:1 t7, Register:f32 $v0, t7:1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Legalized selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg # D:1 t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg # D:1 t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd # D:1 t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg # D:1 t0, Register:f32 $v0, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_FLAG # D:1 t7, Register:f32 $v0, t7:1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Optimized legalized selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg # D:1 t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg # D:1 t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd # D:1 t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg # D:1 t0, Register:f32 $v0, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_FLAG # D:1 t7, Register:f32 $v0, t7:1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===== Instruction selection begins: %bb.0 &#x27;entry&#x27;</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t8: ch = RISCVISD::RET_FLAG # D:1 t7, Register:f32 $v0, t7:1</span><br><span class="line">ISEL: Starting pattern match</span><br><span class="line">  Morphed node: t8: ch = PseudoRET # D:1 Register:f32 $v0, t7, t7:1</span><br><span class="line">ISEL: Match complete!</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t7: ch,glue = CopyToReg # D:1 t0, Register:f32 $v0, t5</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t5: f32 = fadd # D:1 t2, t4</span><br><span class="line">ISEL: Starting pattern match</span><br><span class="line">  Initial Opcode index to 28599</span><br><span class="line">  Match failed at index 28602</span><br><span class="line">  Continuing at 28637</span><br><span class="line">  Match failed at index 28640</span><br><span class="line">  Continuing at 28661</span><br><span class="line">  Match failed at index 28663</span><br><span class="line">  Continuing at 28685</span><br><span class="line">  Match failed at index 28691</span><br><span class="line">  Continuing at 28725</span><br><span class="line">  TypeSwitch[f32] from 28728 to 28731</span><br><span class="line">  Morphed node: t5: f32 = VFADD_VV nofpexcept # D:1 t2, t4</span><br><span class="line">ISEL: Match complete!</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t4: f32,ch = CopyFromReg # D:1 t0, Register:f32 %1</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t2: f32,ch = CopyFromReg # D:1 t0, Register:f32 %0</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t6: f32 = Register $v0</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t3: f32 = Register %1</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t1: f32 = Register %0</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t0: ch,glue = EntryToken</span><br><span class="line"></span><br><span class="line">===== Instruction selection ends:</span><br><span class="line">Selected selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg # D:1 t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg # D:1 t0, Register:f32 %1</span><br><span class="line">    t5: f32 = VFADD_VV nofpexcept # D:1 t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg # D:1 t0, Register:f32 $v0, t5</span><br><span class="line">  t8: ch = PseudoRET # D:1 Register:f32 $v0, t7, t7:1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Total amount of phi nodes to update: 0</span><br><span class="line">*** MachineFunction at end of ISel ***</span><br><span class="line"># Machine code for function fadd_v: IsSSA, TracksLiveness</span><br><span class="line">Function Live Ins: $v0 in %0, $v1 in %1</span><br><span class="line"></span><br><span class="line">bb.0.entry:</span><br><span class="line">  liveins: $v0, $v1</span><br><span class="line">  %1:vgpr = COPY $v1</span><br><span class="line">  %0:vgpr = COPY $v0</span><br><span class="line">  %2:vgpr = nofpexcept VFADD_VV %0:vgpr, %1:vgpr, implicit $frm</span><br><span class="line">  $v0 = COPY %2:vgpr</span><br><span class="line">  PseudoRET implicit $v0</span><br><span class="line"></span><br><span class="line"># End machine code for function fadd_v.</span><br><span class="line"></span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>产生了riscv代码<br>阅读并理解 log 文件中输出的内容，了解指令是如何从 SelectionDAG 节点映射到 MIR 机器指令的。相关资料博客<a target="_blank" rel="noopener" href="https://myhsu.xyz/llvm-codegen-legalization/">Legalizations in LLVM Backend</a><br>那么它总共有这几个流程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Initial selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg # D:1 t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg # D:1 t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd # D:1 t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg # D:1 t0, Register:f32 $v0, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_FLAG # D:1 t7, Register:f32 $v0, t7:1</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这是开始的dag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Optimized lowered selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg # D:1 t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg # D:1 t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd # D:1 t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg # D:1 t0, Register:f32 $v0, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_FLAG # D:1 t7, Register:f32 $v0, t7:1</span><br><span class="line"></span><br><span class="line">对这个DAG图使用pass优化,比如死代码消除等</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Type-legalized selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg # D:1 t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg # D:1 t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd # D:1 t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg # D:1 t0, Register:f32 $v0, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_FLAG # D:1 t7, Register:f32 $v0, t7:1</span><br><span class="line">这里是类型合法化，让当前代码映射到指定架构目标上</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Legalized selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg # D:1 t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg # D:1 t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd # D:1 t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg # D:1 t0, Register:f32 $v0, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_FLAG # D:1 t7, Register:f32 $v0, t7:1</span><br><span class="line">  这里应该还进行了操作合法化</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Optimized legalized selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg # D:1 t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg # D:1 t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd # D:1 t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg # D:1 t0, Register:f32 $v0, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_FLAG # D:1 t7, Register:f32 $v0, t7:1</span><br><span class="line">再进行一遍优化？</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">===== Instruction selection begins: %bb.0 &#x27;entry&#x27;</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t8: ch = RISCVISD::RET_FLAG # D:1 t7, Register:f32 $v0, t7:1</span><br><span class="line">ISEL: Starting pattern match</span><br><span class="line">  Morphed node: t8: ch = PseudoRET # D:1 Register:f32 $v0, t7, t7:1</span><br><span class="line">ISEL: Match complete!</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t7: ch,glue = CopyToReg # D:1 t0, Register:f32 $v0, t5</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t5: f32 = fadd # D:1 t2, t4</span><br><span class="line">ISEL: Starting pattern match</span><br><span class="line">  Initial Opcode index to 28599</span><br><span class="line">  Match failed at index 28602</span><br><span class="line">  Continuing at 28637</span><br><span class="line">  Match failed at index 28640</span><br><span class="line">  Continuing at 28661</span><br><span class="line">  Match failed at index 28663</span><br><span class="line">  Continuing at 28685</span><br><span class="line">  Match failed at index 28691</span><br><span class="line">  Continuing at 28725</span><br><span class="line">  TypeSwitch[f32] from 28728 to 28731</span><br><span class="line">  Morphed node: t5: f32 = VFADD_VV nofpexcept # D:1 t2, t4</span><br><span class="line">ISEL: Match complete!</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t4: f32,ch = CopyFromReg # D:1 t0, Register:f32 %1</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t2: f32,ch = CopyFromReg # D:1 t0, Register:f32 %0</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t6: f32 = Register $v0</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t3: f32 = Register %1</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t1: f32 = Register %0</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t0: ch,glue = EntryToken</span><br><span class="line"></span><br><span class="line">===== Instruction selection ends:</span><br><span class="line"></span><br><span class="line">这里是匹配MIR代码</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">===== Instruction selection ends:</span><br><span class="line">Selected selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg # D:1 t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg # D:1 t0, Register:f32 %1</span><br><span class="line">    t5: f32 = VFADD_VV nofpexcept # D:1 t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg # D:1 t0, Register:f32 $v0, t5</span><br><span class="line">  t8: ch = PseudoRET # D:1 Register:f32 $v0, t7, t7:1</span><br><span class="line"></span><br><span class="line">这里可以看到add指令已经被替换成MIR风格的了</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Total amount of phi nodes to update: 0</span><br><span class="line">*** MachineFunction at end of ISel ***</span><br><span class="line"># Machine code for function fadd_v: IsSSA, TracksLiveness</span><br><span class="line">Function Live Ins: $v0 in %0, $v1 in %1</span><br><span class="line"></span><br><span class="line">bb.0.entry:</span><br><span class="line">  liveins: $v0, $v1</span><br><span class="line">  %1:vgpr = COPY $v1</span><br><span class="line">  %0:vgpr = COPY $v0</span><br><span class="line">  %2:vgpr = nofpexcept VFADD_VV %0:vgpr, %1:vgpr, implicit $frm</span><br><span class="line">  $v0 = COPY %2:vgpr</span><br><span class="line">  PseudoRET implicit $v0</span><br><span class="line"></span><br><span class="line"># End machine code for function fadd_v.</span><br><span class="line">MIR代码如上</span><br></pre></td></tr></table></figure>

<h3 id="3-官方-LLVM-向量-float-测试"><a href="#3-官方-LLVM-向量-float-测试" class="headerlink" title="3. 官方 LLVM 向量 float 测试"></a>3. 官方 LLVM 向量 float 测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">FastISel is disabled</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">=== fadd_v</span><br><span class="line"></span><br><span class="line">Initial selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg t0, Register:f32 $f10_f, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_GLUE t7, Register:f32 $f10_f, t7:1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Optimized lowered selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg t0, Register:f32 $f10_f, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_GLUE t7, Register:f32 $f10_f, t7:1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Type-legalized selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg t0, Register:f32 $f10_f, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_GLUE t7, Register:f32 $f10_f, t7:1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Legalized selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg t0, Register:f32 $f10_f, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_GLUE t7, Register:f32 $f10_f, t7:1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Optimized legalized selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 9 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg t0, Register:f32 %1</span><br><span class="line">    t5: f32 = fadd t2, t4</span><br><span class="line">  t7: ch,glue = CopyToReg t0, Register:f32 $f10_f, t5</span><br><span class="line">  t8: ch = RISCVISD::RET_GLUE t7, Register:f32 $f10_f, t7:1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===== Instruction selection begins: %bb.0 &#x27;entry&#x27;</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t8: ch = RISCVISD::RET_GLUE t7, Register:f32 $f10_f, t7:1</span><br><span class="line">ISEL: Starting pattern match</span><br><span class="line">  Morphed node: t8: ch = PseudoRET Register:f32 $f10_f, t7, t7:1</span><br><span class="line">ISEL: Match complete!</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t7: ch,glue = CopyToReg t0, Register:f32 $f10_f, t5</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t5: f32 = fadd t2, t4</span><br><span class="line">ISEL: Starting pattern match</span><br><span class="line">  Initial Opcode index to 1411309</span><br><span class="line">  TypeSwitch[f32] from 1411314 to 1411317</span><br><span class="line">  Morphed node: t5: f32 = FADD_S nofpexcept t2, t4, TargetConstant:i64&lt;7&gt;</span><br><span class="line">ISEL: Match complete!</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t4: f32,ch = CopyFromReg t0, Register:f32 %1</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t2: f32,ch = CopyFromReg t0, Register:f32 %0</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t6: f32 = Register $f10_f</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t3: f32 = Register %1</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t1: f32 = Register %0</span><br><span class="line"></span><br><span class="line">ISEL: Starting selection on root node: t0: ch,glue = EntryToken</span><br><span class="line"></span><br><span class="line">===== Instruction selection ends:</span><br><span class="line"></span><br><span class="line">Selected selection DAG: %bb.0 &#x27;fadd_v:entry&#x27;</span><br><span class="line">SelectionDAG has 10 nodes:</span><br><span class="line">  t0: ch,glue = EntryToken</span><br><span class="line">      t2: f32,ch = CopyFromReg t0, Register:f32 %0</span><br><span class="line">      t4: f32,ch = CopyFromReg t0, Register:f32 %1</span><br><span class="line">    t5: f32 = FADD_S nofpexcept t2, t4, TargetConstant:i64&lt;7&gt;</span><br><span class="line">  t7: ch,glue = CopyToReg t0, Register:f32 $f10_f, t5</span><br><span class="line">  t8: ch = PseudoRET Register:f32 $f10_f, t7, t7:1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Total amount of phi nodes to update: 0</span><br><span class="line">*** MachineFunction at end of ISel ***</span><br><span class="line"># Machine code for function fadd_v: IsSSA, TracksLiveness</span><br><span class="line">Function Live Ins: $f10_f in %0, $f11_f in %1</span><br><span class="line"></span><br><span class="line">bb.0.entry:</span><br><span class="line">  liveins: $f10_f, $f11_f</span><br><span class="line">  %1:fpr32 = COPY $f11_f</span><br><span class="line">  %0:fpr32 = COPY $f10_f</span><br><span class="line">  %2:fpr32 = nofpexcept FADD_S %0:fpr32, %1:fpr32, 7, implicit $frm</span><br><span class="line">  $f10_f = COPY %2:fpr32</span><br><span class="line">  PseudoRET implicit $f10_f</span><br><span class="line"></span><br><span class="line"># End machine code for function fadd_v.</span><br></pre></td></tr></table></figure>
<p>发现MIR是不同的，主要的不同是寄存器符号的不同和MIR加的指令的表示方式不同</p>
<p>ventus的MIR如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bb.0.entry:</span><br><span class="line">  liveins: $v0</span><br><span class="line">  %0:vgpr = COPY $v0</span><br><span class="line">  %1:gpr = LUI target-flags(riscv-hi) @global_val</span><br><span class="line">  %2:gpr = LW killed %1:gpr, target-flags(riscv-lo) @global_val :: (dereferenceable load (s32) from @global_val)</span><br><span class="line">  %3:gprf32 = COPY %2:gpr</span><br><span class="line">  %5:vgpr = COPY %3:gprf32</span><br><span class="line">  %4:vgpr = nofpexcept VFADD_VV %0:vgpr, killed %5:vgpr, implicit $frm</span><br><span class="line">  $v0 = COPY %4:vgpr</span><br><span class="line">  PseudoRET implicit $v0</span><br></pre></td></tr></table></figure>
<p>官方LLVM是这样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bb.0.entry:</span><br><span class="line">  liveins: $f10_f, $f11_f</span><br><span class="line">  %1:fpr32 = COPY $f11_f</span><br><span class="line">  %0:fpr32 = COPY $f10_f</span><br><span class="line">  %2:fpr32 = nofpexcept FADD_S %0:fpr32, %1:fpr32, 7, implicit $frm</span><br><span class="line">  $f10_f = COPY %2:fpr32</span><br><span class="line">  PseudoRET implicit $f10_f</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>确实，经过对比发现同样的代码，官方会得到标量MIR，承影却会得到向量MIR，可以清晰的通过上面的对比发现，官方是标量加，ventus是向量加。</p>
<h3 id="4-官方-LLVM-向量-half-测试"><a href="#4-官方-LLVM-向量-half-测试" class="headerlink" title="4. 官方 LLVM 向量 half 测试"></a>4. 官方 LLVM 向量 half 测试</h3><h4 id="将-float-ll-中的所有-float-类型替换为-half，得到新的-half-ll。"><a href="#将-float-ll-中的所有-float-类型替换为-half，得到新的-half-ll。" class="headerlink" title="- 将 float.ll 中的所有 float 类型替换为 half，得到新的 half.ll。"></a>- 将 <code>float.ll</code> 中的所有 <code>float</code> 类型替换为 <code>half</code>，得到新的 <code>half.ll</code>。</h4><h4 id="同样使用官方-LLVM-运行-half-ll-得到MIR指令和-log-文件，观察它们跟运行-float-ll-的差异。"><a href="#同样使用官方-LLVM-运行-half-ll-得到MIR指令和-log-文件，观察它们跟运行-float-ll-的差异。" class="headerlink" title="- 同样使用官方 LLVM 运行 half.ll 得到MIR指令和 log 文件，观察它们跟运行 float.ll 的差异。"></a>- 同样使用官方 LLVM 运行 <code>half.ll</code> 得到MIR指令和 log 文件，观察它们跟运行 <code>float.ll</code> 的差异。</h4><h4 id="最后，尝试也用乘影-LLVM-运行-half-ll-，看是否会有报错，如有则记录报错情况并尝试猜测原因，如没有则记录MIR结果和-log-文件并评估是否符合预期。"><a href="#最后，尝试也用乘影-LLVM-运行-half-ll-，看是否会有报错，如有则记录报错情况并尝试猜测原因，如没有则记录MIR结果和-log-文件并评估是否符合预期。" class="headerlink" title="- 最后，尝试也用乘影 LLVM 运行 half.ll ，看是否会有报错，如有则记录报错情况并尝试猜测原因，如没有则记录MIR结果和 log 文件并评估是否符合预期。"></a>- 最后，尝试也用乘影 LLVM 运行 <code>half.ll</code> ，看是否会有报错，如有则记录报错情况并尝试猜测原因，如没有则记录MIR结果和 log 文件并评估是否符合预期。</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py</span><br><span class="line">; RUN: llc -mtriple=riscv32 -mcpu=ventus-gpgpu -verify-machineinstrs &lt; %s \</span><br><span class="line">; RUN:   | FileCheck -check-prefix=VENTUS %s</span><br><span class="line"></span><br><span class="line">define half @fadd_v(half noundef %a, half noundef %b) &#123;</span><br><span class="line">; VENTUS-LABEL: fadd_v:</span><br><span class="line">; VENTUS:       # %bb.0: # %entry</span><br><span class="line">; VENTUS-NEXT:    vfadd.vv v0, v0, v1</span><br><span class="line">; VENTUS-NEXT:    ret</span><br><span class="line">entry:</span><br><span class="line">  %add = fadd half %a, %b</span><br><span class="line">  ret half %add</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define half @fadd_f(half noundef %a) &#123;</span><br><span class="line">; VENTUS-LABEL: fadd_f:</span><br><span class="line">; VENTUS:       # %bb.0: # %entry</span><br><span class="line">; VENTUS-NEXT:    lui t0, %hi(global_val)</span><br><span class="line">; VENTUS-NEXT:    lw t0, %lo(global_val)(t0)</span><br><span class="line">; VENTUS-NEXT:    vmv.v.x v1, t0</span><br><span class="line">; VENTUS-NEXT:    vfadd.vv v0, v0, v1</span><br><span class="line">; VENTUS-NEXT:    ret</span><br><span class="line">entry:</span><br><span class="line">  %val = load half, ptr @global_val, align 4</span><br><span class="line">  %add = fadd half %a, %val</span><br><span class="line">  ret half %add</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define half @fsub_v(half noundef %a, half noundef %b) &#123;</span><br><span class="line">; VENTUS-LABEL: fsub_v:</span><br><span class="line">; VENTUS:       # %bb.0: # %entry</span><br><span class="line">; VENTUS-NEXT:    vfsub.vv v0, v0, v1</span><br><span class="line">; VENTUS-NEXT:    ret</span><br><span class="line">entry:</span><br><span class="line">  %add = fsub half %a, %b</span><br><span class="line">  ret half %add</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先用官方llvm编译,但是修改后仍然报错<br>但是官方执行<code>/home/wjsun/LLVM/build/bin/llc -march=riscv32 -mattr=+v,+zvfh --debug-only=isel half.ll &amp;&gt; out.log</code>仍然报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/home/wjsun/LLVM/build/bin/llc: error: /home/wjsun/LLVM/build/bin/llc: half.ll:369:25: error: floating point constant invalid for type</span><br><span class="line">  %fneg = fmul half %b, 0xBFF3333340000000</span><br></pre></td></tr></table></figure>
<p>都是因为不符合half的存储长度造成的。那么用ventusllvm会好吗？<br>执行命令<code>/home/sunwenjia/ventus/llvm-project/install/bin/llc  -mtriple=riscv32 -mcpu=ventus-gpgpu --debug-only=isel float.ll &amp;&gt; out3.log</code><br>也没有改变</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/home/sunwenjia/ventus/llvm-project/install/bin/llc: error: /home/sunwenjia/ventus/llvm-project/install/bin/llc: float.ll:207:14: error: floating point constant invalid for type</span><br><span class="line">  store half 0x3FF3333340000000, ptr addrspace(5) %b, align 4</span><br><span class="line">             ^</span><br><span class="line"></span><br><span class="line">             ^</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sabyic.github.io/2025/05/21/hello-world/" data-id="cmaxlgd6i0002kzq2he4zejo9" data-title="ventus LLVM 初步 调研" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-report-fix" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/21/report-fix/" class="article-date">
  <time class="dt-published" datetime="2025-05-21T07:00:44.710Z" itemprop="datePublished">2025-05-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/05/21/report-fix/">ventus LLVM 初步 调研 report-fix</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Q:第一个细节是技术上要注意一下：ventus-llvm的llc调用命令要参考ventus-llvm的readme，加上<code>-mtriple=riscv32 -mcpu=ventus-gpgpu</code>；而官方llvm的llc调用命令则是加上<code>-mtriple=riscv32 -mattr=+v,+zvfh</code>。这样应该就能解决“承影的产生代码是x86MIR而不是RISC-V MIR”以及“官方llvm跑half.ll会报错”的问题，试一试。<br>A:加上-mtriple&#x3D;riscv32 -mcpu&#x3D;ventus-gpgpu确实产生了riscv的MIR 但是官方执行<code>/home/wjsun/LLVM/build/bin/llc -march=riscv32 -mattr=+v,+zvfh --debug-only=isel half.ll &amp;&gt; out.log</code>仍然报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/home/wjsun/LLVM/build/bin/llc: error: /home/wjsun/LLVM/build/bin/llc: half.ll:369:25: error: floating point constant invalid for type</span><br><span class="line">  %fneg = fmul half %b, 0xBFF3333340000000</span><br><span class="line">                        ^</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Q:<br>第二个细节是表达上要注意一下：要展示MIR的差异之处的话，可以直接把ventus-llvm和官方llvm在“&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; Instruction selection ends:”之后的结果摆在一起，这样再得出“MIR加的指令的表示方式不同”的结论，这样会更加顺畅；而要展示发现有报错时，在贴报错信息的时候可以同步贴上执行命令，方便后续复现。<br>A：已修改()<br>Q:</p>
<ol>
<li>对于float.ll的测试，这里的差别确实是MIR加的指令的表示方式不同，不过更具体来说，是官方llvm会产生标量加指令FADD_S，而ventus-llvm却会出现向量加指令VFADD_VV。是的，同样的代码，官方会得到标量MIR，承影却会得到向量MIR，这是一个重点。<br>A:是的！完全是这样的。<br>Q:由于官方llvm对于float.ll和half.ll都只生成标量代码，如果把“-mattr&#x3D;+v,+zvfh”换成“-mattr&#x3D;+zfh”，可以看到最终结果跟“支持标量half”文档里官方llvm的结果应该是相似的。<br>执行&#x2F;home&#x2F;wjsun&#x2F;LLVM&#x2F;build&#x2F;bin&#x2F;llc -march&#x3D;riscv32 -mattr&#x3D;+zfh –debug-only&#x3D;isel half.ll &amp;&gt; out.log</li>
</ol>
<p>仍然报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/home/wjsun/LLVM/build/bin/llc: error: /home/wjsun/LLVM/build/bin/llc: half.ll:369:25: error: floating point constant invalid for type</span><br><span class="line">  %fneg = fmul half %b, 0xBFF3333340000000</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://sabyic.github.io/2025/05/21/report-fix/" data-id="cmaxlgd6i0003kzq2c81odojt" data-title="ventus LLVM 初步 调研 report-fix" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-first-post" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/19/first-post/" class="article-date">
  <time class="dt-published" datetime="2025-05-19T13:51:19.000Z" itemprop="datePublished">2025-05-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/05/19/first-post/">first-post</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://sabyic.github.io/2025/05/19/first-post/" data-id="cmaxlgd6g0001kzq25rk6c1ck" data-title="first-post" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/05/21/2020.5.21/">2025-5-21-为什么官方LLVM会报错的思考</a>
          </li>
        
          <li>
            <a href="/2025/05/21/hello-world/">ventus LLVM 初步 调研</a>
          </li>
        
          <li>
            <a href="/2025/05/21/report-fix/">ventus LLVM 初步 调研 report-fix</a>
          </li>
        
          <li>
            <a href="/2025/05/19/first-post/">first-post</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 wjsun<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>